preprocessing:
  # All preprocessing steps
  # As list because run order is preserved
  # All params are passed to relevant function in spikeinterface
  - 
    step_name: bandpass_filter # si.bandpass_filter
    step_params: 
      freq_min: 300.0
      freq_max: 12000.0
  -
    step_name: phase_shift # si.phase_shift
    step_params: {}
  -
    step_name: common_reference # si.common_reference
    step_params:
      reference: 'local'
      operator: 'median'
  -
    step_name: whiten # si.whiten, NB: Need to scale if whitening!
    step_params: {}
  -
    step_name: scale # si.scale, NB: Only if whitening
    step_params:
      gain: 200.0
      offset: 0.0
  -
    step_name: drift_correction # preprocess_si_rec._prepro_drift_correction
    step_params:
      # One param dict for each substep
      noise_level_params: {}
      peak_detection_params:
        method: 'locally_exclusive'
        local_radius_um: 150
        peak_sign: 'neg'
        detect_threshold: 5
        exclude_sweep_ms: 0.1
      extract_waveforms_params:
        ms_before: 0.3
        ms_after: 0.6
      peak_localization_method: 'monopolar_triangulation'
      peak_localization_params:
        # Common to "monopolar_triangulation" and "center_of_mass" methods
        local_radius_um: 150.0
        # Below only for "monopolar_triangulation" method
        max_distance_um: 400
        optimizer: 'minimize_with_log_penality'
      motion_params: 
        # General
        bin_duration_s: 10.0
        bin_um: 1.0  # Should be smaller than non_rigid_params.bin_step_um
        margin_um: 0.0
        rigid: False
        win_shape: "gaussian"
        win_step_um: 1000.0
        win_sigma_um: 3000.0
      motion_method_params:
        method: "decentralized"
        pairwise_displacement_method: 'conv'
        max_displacement_um: 400.0
        weight_scale: "linear"
        convergence_method: 'lsqr_robust'
        robust_regression_sigma: 2.0
        lsqr_robust_n_iter: 20
        conv_engine: 'torch'
        corr_threshold: 0.7
        time_horizon_s: null
        soft_weights: false
        temporal_prior: true
        spatial_prior: false
        reference_displacement: median
        weight_with_amplitude: false
      clean_motion_params:
        speed_threshold: 5  # um/sec
        sigma_smooth_s: null
sorting:
  sorter_name: kilosort2_5
  sorter_path: "/Volumes/scratch/neuropixels/matlab/external/Kilosort-upstream-v2.5"
  sorter_params:  # Passed directly to spikeinterface.run_sorter
    skip_kilosort_preprocessing: True  # DO NOT TOUCH
    scaleproc: 200  # DO NOT TOUCH: MUST be equal to post-whitening scaling during postpro
    nblocks: 0  # DO NOT TOUCH: Effectively skip running kilosort's datashift2.m
    do_correction: False  # DO NOT TOUCH: Effectively skip running kilosort's datashift2.m . Ignord if nblocks=0
    car: True # Ignored
    detect_threshold: 6
    projection_threshold: [10, 4]
    preclust_threshold: 8
    minFR: 0.1
    minfr_goodchannels: 0.1
    sig: 20
    freq_min: 150
    sigmaMask: 30
    nPCs: 3
    ntbuff: 64
    nfilt_factor: 4
    NT: null
    keep_good_only: False